function wrap(t,e){t.each(function(){for(var t,a=d3.select(this),o=a.text().split(/\s+/).reverse(),r=[],i=0,n=1.1,s=a.attr("y"),l=parseFloat(a.attr("dy")),c=a.text(null).append("tspan").attr("x",0).attr("y",s).attr("dy",l+"em");o.length;)t=o.pop(),r.push(t),c.text(r.join(" ")),c.node().getComputedTextLength()>e&&(r.pop(),c.text(r.join(" ")),r=[t],c=a.append("tspan").attr("x",0).attr("y",s).attr("dy",++i*n+l+"em").text(t))})}function barchart(t,e){var a=Utils.createColorScale(t.map(function(t){return t.score})),o=t.slice(0,e),r={top:40,right:80,bottom:40,left:20},i=600-r.left-r.right,n=400-r.top-r.bottom,s="0 0 600 400",l=d3.scale.linear().range([0,i]),c=d3.scale.ordinal().rangeRoundBands([0,n],.2),d=d3.svg.axis().scale(l).orient("bottom").ticks(10),p=d3.svg.axis().scale(c).orient("left"),u=d3.select(".chart").append("svg").attr("viewBox",s).append("g").attr("transform","translate("+r.left+","+r.top+")");o.forEach(function(t){t.score=+t.score,t.value=+t.value}),o.sort(function(t,e){return t.rank-e.rank}),l.domain([0,d3.max(o,function(t){return t.value})]),c.domain(o.map(function(t){return t.rank})),u.append("g").attr("class","x axis").attr("transform","translate(0,"+n+")").call(d).append("text").attr("transform","translate("+(i+50)+", 0)").attr("y",0).attr("dy",0).attr("text-anchor","middle").attr("class","label label--x").text("FSI-verdi").call(wrap,60),u.append("g").attr("class","y axis").call(p).append("text").attr("y",0).attr("dy",-10).attr("text-anchor","middle").attr("class","label label--y").text("Plassering"),u.selectAll(".bar").data(o).enter().append("rect").attr("class","bar").style("fill",function(t){return a(t.score)}).attr("y",function(t){return c(t.rank)}).attr("height",c.rangeBand()).attr("x",2).attr("width",function(t){return l(t.value)}),u.selectAll(".text").data(o).enter().append("text").text(function(t){return t.jurisdiction}).attr("x",function(t){return l(t.value)+10}).attr("y",function(t){return c(t.rank)}).attr("dy",c.rangeBand()/1.8).attr("class","label")}!function(t,e,a,o){"use strict";var r={createColorScale:function(t){var o=a.filter(t,function(t){return!isNaN(t)}),r=[e.min(o),e.max(o)],i=["#ffffb2","#fecc5c","#fd8d3c","#fd8d3c","#f03b20","#bd0026","#bd0026"];return e.scale.quantize().domain(r).range(i)}};t.Utils=r}(window,d3,_),function(t,e,a,o,r,i,n,s,l,c,d,p){"use strict";a.TopoJSON=a.GeoJSON.extend({addData:function(t){if("Topology"===t.type)for(var e in t.objects){var o=i.feature(t,t.objects[e]);a.GeoJSON.prototype.addData.call(this,o)}else a.GeoJSON.prototype.addData.call(this,t);return this}}),o.DEBUG=/unminified/.test(function(){});var u=new o({template:"#baseTemplate",el:"#storyteller",data:{loading:!0,current:1,next:2},scoreToColor:!1,map:{},fsi:{},mapOverlays:a.layerGroup(),divIcon:a.divIcon({className:"my-div-icon",iconSize:[10,10]}),positions:{small:{center:{top:40,left:40,bottom:40,right:40},tl:{top:5,left:5,bottom:70,right:70},tr:{top:5,left:70,bottom:70,right:5},br:{top:70,left:70,bottom:5,right:5},bl:{top:70,left:5,bottom:5,right:70}},medium:{center:{top:30,left:30,bottom:30,right:30},tl:{top:5,left:5,bottom:55,right:55},tr:{top:5,left:55,bottom:55,right:5},br:{top:55,left:55,bottom:5,right:5},bl:{top:55,left:5,bottom:5,right:55}},large:{center:{top:20,left:20,bottom:20,right:20},tl:{top:5,left:5,bottom:40,right:40},tr:{top:5,left:40,bottom:40,right:5},br:{top:40,left:40,bottom:5,right:5},bl:{top:40,left:5,bottom:5,right:40}}},oninit:function(){this.loadJson();var t=this,e=!1;a.Icon.Default.imagePath="images/",this.map=a.map("map",{zoomControl:e,dragging:e,touchZoom:e,scrollWheelZoom:e,doubleClickZoom:e}),a.tileLayer("http://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',subdomains:"abcd",unloadInvisibleTiles:!e,reuseTiles:e}).addTo(this.map),this.mapOverlays.addTo(this.map),this.map.on("zoomend",function(){setTimeout(function(){t.transitionEnd()},100)}),this.observe("current",function(t,e){t!==p&&t!==e&&this.get("loading")===!1&&this["goto"](t)}),e&&this.map.on("click",function(t){console.log("["+t.latlng.lat+", "+t.latlng.lng+"]")})},"goto":function(t){this.transitionStart();var e,a=this.get("slides"),o=this.get("total");t>o&&(t=1),e=a[Math.max(0,t-1)],e.pos=this.positions[e.size][e.position],this.set({next:t===o?1:t+1,slide:e}).then(this.updateMap()),s.has(e,"animateTo")&&this.animateSlide(),d("set",{page:"/#/page/"+this.get("current"),title:this.get("slide.title")}),d("send","pageview")},animateSlide:function(){var t=this,e=this.get("slide.animateTo");setTimeout(function(){t.animate({"slide.pos":t.positions[e.size][e.position],"slide.size":e.size},{duration:800,easing:"easeInOut"})},this.get("slide.animateTo.duration"))},updateMap:function(){var t=this,e=this.get("slide.map"),o={};this.mapOverlays.clearLayers(),t.divIcon.options.html="",this.map.getZoom()===p?this.map.setView(e.position,e.zoom):this.map.flyTo(e.position,e.zoom,s.extend(o,e.panOptions)),s.has(e,"markers")&&s.each(e.markers,function(e){e.label&&(t.divIcon.options.html="<h2>"+e.label+"</h2>"),t.mapOverlays.addLayer(a.marker(e.point,{icon:t.divIcon}))}),s.has(e,"highlights")&&this.higlightCountries(e.highlights)},higlightCountries:function(t){var e=new a.TopoJSON,o=JSON.parse(JSON.stringify(this.topoJson));t.hasOwnProperty("all")||(o.objects.subunits.geometries=s.filter(this.topoJson.objects.subunits.geometries,function(e){return t.hasOwnProperty(e.id)})),e.addData(o).setStyle(function(t){return{fillColor:u.scoreToColor(t.properties.score),weight:1,opacity:.6,color:"#fff",fillOpacity:.8}}).eachLayer(function(t){t.bindPopup(t.feature.properties.name)}),6===this.get("current")&&e.setStyle({fillColor:"#bd0026"}),this.mapOverlays.addLayer(e)},transitionStart:function(){this.set("chartEnabled",!1),this.set("visible",!1)},transitionEnd:function(){var t=this;this.set("visible",!0).then(function(){var e=t.get("slide.callback");e&&t[e]()})},loadJson:function(){function t(t,a,o,r){if(t)return console.error(t);e.fsi=r,e.set({loading:!1,slides:a.data,total:a.data.length});for(var i in o.objects)for(var n in o.objects[i].geometries){var l=o.objects[i].geometries[n],d=s.find(r,function(t){return t.countryCode===l.id});s.extend(l.properties,s.pick(d,"rank","score","value"))}e.topoJson=o,e.scoreToColor=c.createColorScale(s.pluck(r,"score")),e["goto"](e.get("current"))}var e=this;n().defer(r.json,"/slides.json").defer(r.json,"/data/all.json").defer(r.json,"/fsi/2015.json?limit=102").await(t)},callbackChartView:function(){this.set("chartEnabled",!0),l(this.fsi,10)},callbackdrawUKLines:function(){var t,e,o,r,i=this;t=[51.50729340171854,-.12767851352691653],e=[[t,[4.434044005032582,114.60937500000001]],[t,[-20.4167169889457,57.48046875000001]],[t,[32.30106302536928,-64.76440429687501]],[t,[24.567108352576,-77.92602539062501]],[t,[19.290405639498005,-81.29882812500001]],[t,[18.46918890441719,-64.37988281250001]],[t,[17.088291217955476,-61.77612304687501]],[t,[16.70986293320658,-62.20458984375001]],[t,[17.151288449816747,-62.57812500000001]],[t,[18.245003052249718,-63.00659179687501]],[t,[15.355707666100942,-61.32843017578126]],[t,[13.93140140744916,-60.94665527343751]],[t,[13.250639570043104,-61.18835449218751]],[t,[12.076924304193847,-61.66900634765626]],[t,[49.48061694200378,-2.5762939453125004]],[t,[49.19785878427575,-2.0352172851562504]],[t,[54.25238930276849,-4.592285156250001]],[t,[36.12414877519126,-5.346221923828126]],[t,[21.476672479184234,-71.14870548248292]],[t,[-21.22218129956861,-159.7892761230469]]],o={color:"#bd0026",opacity:.7},r=a.polyline(e,o).addTo(this.map),this.mapOverlays.addLayer(r),s.each(e,function(t){i.mapOverlays.addLayer(a.circleMarker(t[1],o).setRadius(2))})}});t.storyTeller=u,e.onkeydown=function(e){var a=u.get("current"),o=u.get("next");switch(e=e||t.event,e.which||e.keyCode){case 37:u.set("current",a-1);break;case 39:u.set("current",o);break;default:return}e.preventDefault()}}(window,document,L,Ractive,d3,topojson,queue,_,barchart,Utils,ga),function(t,e,a,o){"use strict";var r=new e({"/page/:index":function(e){var o=a.get("total");e=+e,1>e?e=1:o&&e>o&&(a.set("current",1),t.location.hash=""),a.set("current",e)}});r.configure({notfound:function(){a.set("current",1),t.location.hash=""}}),r.init()}(window,Router,storyTeller);