function wrap(t,e){t.each(function(){for(var t,o=d3.select(this),a=o.text().split(/\s+/).reverse(),i=[],r=0,n=1.1,s=o.attr("y"),l=parseFloat(o.attr("dy")),p=o.text(null).append("tspan").attr("x",0).attr("y",s).attr("dy",l+"em");a.length;)t=a.pop(),i.push(t),p.text(i.join(" ")),p.node().getComputedTextLength()>e&&(i.pop(),p.text(i.join(" ")),i=[t],p=o.append("tspan").attr("x",0).attr("y",s).attr("dy",++r*n+l+"em").text(t))})}function barchart(t){var e={top:40,right:80,bottom:40,left:0},o=600-e.left-e.right,a=400-e.top-e.bottom,i="0 0 600 400",r=d3.scale.linear().range([0,o]),n=d3.scale.ordinal().rangeRoundBands([0,a],.2),s=d3.svg.axis().scale(r).orient("bottom").ticks(10),l=d3.svg.axis().scale(n).orient("left"),p=d3.select(".chart").append("svg").attr("viewBox",i).append("g").attr("transform","translate("+e.left+","+e.top+")");d3.json(t,function(t,e){if(t)throw t;e.forEach(function(t){t.score=+t.score}),e.sort(function(t,e){return t.rank-e.rank}),r.domain([0,100]),n.domain(e.map(function(t){return t.rank})),p.append("g").attr("class","x axis").attr("transform","translate(0,"+a+")").call(s).append("text").attr("transform","translate("+(o+50)+", 0)").attr("y",0).attr("dy",0).attr("text-anchor","middle").attr("class","label label--x").text("Secrecy Score").call(wrap,60),p.append("g").attr("class","y axis").call(l).append("text").attr("y",0).attr("dy",-10).attr("text-anchor","middle").attr("class","label label--y").text("FSI Rank"),p.selectAll(".bar").data(e).enter().append("rect").attr("class","bar").attr("y",function(t){return n(t.rank)}).attr("height",n.rangeBand()).attr("x",2).attr("width",function(t){return r(t.score)}),p.selectAll(".text").data(e).enter().append("text").text(function(t){return t.jurisdiction}).attr("x",function(t){return r(t.score)+10}).attr("y",function(t){return n(t.rank)}).attr("dy",n.rangeBand()/1.8).attr("class","label")})}!function(t,e,o,a,i,r,n,s,l,p){"use strict";function c(t){return t>77?"#800026":t>73?"#BD0026":t>70?"#E31A1C":t>60?"#FC4E2A":t>50?"#FD8D3C":t>40?"#FEB24C":t>30?"#FED976":"#FFEDA0"}function h(t){return{fillColor:c(t.properties.score),weight:2,opacity:1,color:"white",dashArray:"3",fillOpacity:.7}}function d(t){var e=new XMLHttpRequest;e.overrideMimeType("application/json"),e.responseType="json",e.open("GET","/slides.json",!0),e.onreadystatechange=function(){4===e.readyState&&200===e.status&&t(e.response)},e.send(null)}var u=a.extend({template:"#baseTemplate",map:{},topoJson:!1,mapMarkers:o.layerGroup(),mapGeoJSON:o.layerGroup(),positions:{small:{center:{top:40,left:40,bottom:40,right:40},tl:{top:5,left:5,bottom:70,right:70},tr:{top:5,left:70,bottom:70,right:5},br:{top:70,left:70,bottom:5,right:5},bl:{top:70,left:5,bottom:5,right:70}},medium:{center:{top:30,left:30,bottom:30,right:30},tl:{top:5,left:5,bottom:55,right:55},tr:{top:5,left:55,bottom:55,right:5},br:{top:55,left:55,bottom:5,right:5},bl:{top:55,left:5,bottom:5,right:55}},large:{center:{top:20,left:20,bottom:20,right:20},tl:{top:5,left:5,bottom:40,right:40},tr:{top:5,left:40,bottom:40,right:5},br:{top:40,left:40,bottom:5,right:5},bl:{top:40,left:5,bottom:5,right:40}}},oninit:function(){this.loadJson();var t=this,e=!0;o.Icon.Default.imagePath="images/",this.map=o.map("map",{zoomControl:e,dragging:e,touchZoom:e,scrollWheelZoom:e,doubleClickZoom:e}),o.tileLayer("http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',subdomains:"abcd",unloadInvisibleTiles:!1,reuseTiles:!0}).addTo(this.map),this.mapMarkers.addTo(this.map),this.mapGeoJSON.addTo(this.map),this.on("goto",function(t,e){this.transitionStart(),this["goto"](e)}),this.map.on("zoomend",function(){setTimeout(function(){t.transitionEnd()},100)}),this["goto"](0)},"goto":function(t){var e,o=this.get("slides"),a=o.length-1;0>t?t=a:t>a&&(t=0),e=o[t],e.pos=this.positions[e.size][e.position];var i=this.set({current:t,slide:e});i.then(this.updateMap()),s.has(e,"animateTo")&&this.animateSlide()},animateSlide:function(){var t=this,e=this.get("slide.animateTo");setTimeout(function(){t.animate({"slide.pos":t.positions[e.size][e.position],"slide.size":e.size},{duration:800,easing:"easeInOut"})},this.get("slide.animateTo.duration"))},updateMap:function(){var t=this,e=this.get("slide.map"),a={};this.mapMarkers.clearLayers(),this.mapGeoJSON.clearLayers(),this.map.getZoom()===p?this.map.setView(e.position,e.zoom):this.map.flyTo(e.position,e.zoom,s.extend(a,e.panOptions)),s.has(e,"markers")&&s.each(e.markers,function(e){t.mapMarkers.addLayer(o.marker(e))}),s.has(e,"highlights")&&(this.topoJson?this.higlightCountries(e.highlights):setTimeout(this.higlightCountries(e.highlights),1e3))},higlightCountries:function(t){if(this.topoJson){var e=new o.TopoJSON,a=JSON.parse(JSON.stringify(this.topoJson));t.hasOwnProperty("all")||(a.objects.subunits.geometries=s.filter(this.topoJson.objects.subunits.geometries,function(e){return t.hasOwnProperty(e.id)})),e.addData(a).setStyle(h).eachLayer(function(t){t.bindPopup(t.feature.properties.name)}),this.mapGeoJSON.addLayer(e)}},transitionStart:function(){this.set("chartEnabled",!1),this.set("visible",!1)},transitionEnd:function(){var t=this;this.set("visible",!0).then(function(){var e=t.get("slide.callback");e&&t[e]()})},loadJson:function(){function t(t,o,a){if(t)return console.error(t);for(var i in o.objects)for(var r in o.objects[i].geometries){var n=o.objects[i].geometries[r],l=s.find(a,function(t){return t.countryCode===n.id});s.extend(n.properties,s.pick(l,"rank","score","value"))}e.topoJson=o}var e=this;n().defer(i.json,"/data/all.json").defer(i.json,"/fsi/2015.json?limit=102").await(t)},callbackChartView:function(){this.set("chartEnabled",!0),l("/fsi/2015.json?limit=10")}});d(function(t){var e=t.data;new u({el:"#storyteller",data:{visible:!0,slides:e}})})}(window,document,L,Ractive,d3,topojson,queue,_,barchart);